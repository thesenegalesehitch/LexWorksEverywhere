name: CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - name: Install flake8 and project
        run: |
          python -m pip install --upgrade pip
          python -m pip install .
          python -m pip install flake8
      - name: Lint
        run: flake8 lexworkseverywhere

  tests:
    runs-on: ${{ matrix.os }}
    permissions:
      contents: write
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        python-version: ["3.10", "3.11", "3.12", "pypy-3.10"]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install test dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install .
          python -m pip install pytest pytest-cov

      - name: Run tests with coverage
        run: python -m pytest -q --cov=lexworkseverywhere --cov-report=xml --cov-report=html

      - name: Upload coverage artifacts
        uses: actions/upload-artifact@v4
        with:
          name: coverage-${{ matrix.os }}-${{ matrix.python-version }}
          path: |
            coverage.xml
            htmlcov/**

      - name: Generate coverage badge (Ubuntu, Py3.12, main only)
        if: ${{ matrix.os == 'ubuntu-latest' && matrix.python-version == '3.12' && github.event_name == 'push' && github.ref == 'refs/heads/main' }}
        run: |
          python - << 'PY'
          import os, xml.etree.ElementTree as ET, math
          tree = ET.parse('coverage.xml')
          root = tree.getroot()
          rate = root.get('line-rate')
          pct = round(float(rate)*100, 1) if rate else 0.0
          color = 'brightgreen' if pct >= 90 else ('green' if pct >= 80 else ('yellow' if pct >= 70 else 'orange'))
          svg = f'''<svg xmlns="http://www.w3.org/2000/svg" width="150" height="20">
          <linearGradient id="b" x2="0" y2="100%"><stop offset="0" stop-color="#bbb" stop-opacity=".1"/><stop offset="1" stop-opacity=".1"/></linearGradient>
          <mask id="a"><rect width="150" height="20" rx="3" fill="#fff"/></mask>
          <g mask="url(#a)"><rect width="80" height="20" fill="#555"/><rect x="80" width="70" height="20" fill="{color}"/><rect width="150" height="20" fill="url(#b)"/></g>
          <g fill="#fff" text-anchor="middle" font-family="DejaVu Sans,Verdana,Geneva,sans-serif" font-size="11">
          <text x="40" y="15" fill="#010101" fill-opacity=".3">coverage</text><text x="40" y="14">coverage</text>
          <text x="115" y="15" fill="#010101" fill-opacity=".3">{pct}%</text><text x="115" y="14">{pct}%</text>
          </g>
          </svg>'''
          os.makedirs('badges', exist_ok=True)
          with open(os.path.join('badges','coverage.svg'),'w') as f:
              f.write(svg)
          PY

      - name: Upload coverage badge artifact
        if: ${{ matrix.os == 'ubuntu-latest' && matrix.python-version == '3.12' }}
        uses: actions/upload-artifact@v4
        with:
          name: coverage-badge
          path: badges/coverage.svg

      - name: Commit coverage badge
        if: ${{ matrix.os == 'ubuntu-latest' && matrix.python-version == '3.12' && github.event_name == 'push' && github.ref == 'refs/heads/main' }}
        uses: EndBug/add-and-commit@v9
        with:
          add: "badges/coverage.svg"
          message: "chore(ci): update coverage badge"
